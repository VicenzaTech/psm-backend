generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum LoaiMai {
  mai_nong
  mai_nguoi
}

model BrickType {
  id     Int    @id @default(autoincrement())
  /// "300x600_PORCELAIN"
  code   String @unique @db.VarChar(100)
  /// "300x600mm Porcelain mài bóng"
  name   String @db.VarChar(200)
  /// Kích thước hiển thị: "300x600mm"
  size_x Int
  size_y Int

  /// Loại gạch (porcelain, granite, ...)
  type String

  /// Loại mài: mài nóng / người / không mài
  loaiMai LoaiMai

  /// Thời gian chờ mài người (giờ), nếu có
  thoiGianChoMaiNguoiHours Int?

  workshopId       String
  /// (Optional) nếu sau này khoán theo dây chuyền
  productionLineId String

  // Chu kỳ & Sản lượng khoán
  chuKyKhoan              Int // phút
  sanLuongRaLoPerDay      Decimal @db.Decimal(10, 2) // m²/ngày
  sanLuongChinhPhamPerDay Decimal @db.Decimal(10, 2) // m²/ngày

  /// Số ngày trừ khoán (mặc định 1.5)
  soNgayTruKhoan Decimal @default(1.5) @db.Decimal(5, 2)

  /// Khoán theo số ngày trong tháng
  sanLuongKhoan30Ngay Decimal @db.Decimal(10, 2) // m²
  sanLuongKhoan31Ngay Decimal @db.Decimal(10, 2) // m²

  /// Điều chỉnh khoán khi giảm/tăng chu kỳ
  congKhoanGiamChuKy Decimal @db.Decimal(10, 2) // m²/ngày
  giamKhoanTangChuKy Decimal @db.Decimal(10, 2) // m²/ngày

  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// ===============================
// ENUM GỢI Ý
// ===============================
enum ActivityEntityType {
  User
  BrickType
  ProductionPlan
  StageAssignment
  DailyStageProduction
  QualityRecord
  MeasurementCache
  Workshop
  ProductionLine
  Device
  DeviceCluster
  Setting
  Other
  Attachment
  ApiToken
  MeasurementType
  SalaryPeriod
}

enum ActivityStatus {
  SUCCESS
  FAILED
}

enum ActivitySeverity {
  INFO
  WARNING
  ERROR
  SECURITY // hành động nhạy cảm: phân quyền, đổi mật khẩu, v.v.
}

enum ActivitySource {
  WEB_ADMIN
  WEB_APP
  API
  IOT_SYNC
  JOB      // cron / background job
  SYSTEM   // hành động hệ thống tự làm
}
// ===============================
// ACTIVITY LOG
// ===============================
model ActivityLog {
  id String @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid

  // WHO: cho phép null để log cả action "system"
  userId       Int?    @map("user_id")
  // WHAT
  action     String              @db.VarChar(80)      // mã hành động cụ thể: "UPDATE_BRICK_TYPE", "RUN_SALARY_JOB"
  actionType String              @map("action_type")  // nhóm hành động
  // ON WHICH ENTITY
  entityType ActivityEntityType? @map("entity_type")
  entityId   Int?                @map("entity_id")
  entityName String?             @map("entity_name") @db.VarChar(200)
  // RESULT + CONTEXT
  status   ActivityStatus   // SUCCESS / FAILED
  severity ActivitySeverity // INFO / WARNING / ERROR / SECURITY
  source   ActivitySource   // WEB_ADMIN / API / IOT_SYNC / JOB / SYSTEM
  metadata Json?            // JSON nhẹ: { before, after, extraCodes }
  // EXTRA INFO
  description String? @db.Text
  createdAt DateTime @default(now()) @map("created_at")
  user User? @relation(fields: [userId], references: [id])
  @@index([userId, createdAt])
  @@index([entityType, entityId, createdAt])
  @@index([actionType, createdAt])
  @@index([source, createdAt])
  @@index([createdAt])
  @@map("activity_logs")
}


model User {
  id           Int      @id @default(autoincrement())
  username     String   @unique @db.VarChar(50)
  email        String   @unique @db.VarChar(150)
  fullName     String   @map("full_name") @db.VarChar(150)
  passwordHash String   @map("password_hash") @db.VarChar(255)
  isActive     Boolean  @default(true) @map("is_active")

  lastLoginAt  DateTime? @map("last_login_at")
  createdAt    DateTime  @default(now()) @map("created_at")
  updatedAt    DateTime  @updatedAt      @map("updated_at")

  roles        Role[]      @relation("UserRoles")

  activityLogs ActivityLog[]

  @@index([isActive])
  @@index([username])
  @@map("users")
}

model Role {
  id          Int      @id @default(autoincrement())
  code        String   @unique @db.VarChar(50)   // super_admin, admin, ...
  name        String   @db.VarChar(100)
  description String?  @db.VarChar(255)
  isActive    Boolean  @default(true) @map("is_active")

  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt      @map("updated_at")

  users       User[]        @relation("UserRoles")
  permissions Permission[]  @relation("RolePermissions")

  @@index([isActive])
  @@map("roles")
}

model Permission {
  id          Int      @id @default(autoincrement())
  code        String   @unique @db.VarChar(100) // "user.view", ...
  name        String   @db.VarChar(150)
  description String?  @db.VarChar(255)

  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt      @map("updated_at")

  roles       Role[] @relation("RolePermissions")

  @@map("permissions")
}